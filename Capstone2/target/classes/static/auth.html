<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Capstone2 - Auth</title>

    <style>
        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background: #f3f4f6;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            background: #ffffff;
            width: 420px;
            padding: 24px 24px 16px;
            border-radius: 10px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.08);
        }

        h1 {
            margin: 0 0 10px;
            font-size: 22px;
            text-align: center;
            color: #111827;
        }

        .subtitle {
            text-align: center;
            margin-bottom: 16px;
            color: #6b7280;
            font-size: 13px;
        }

        .tabs {
            display: flex;
            margin-bottom: 16px;
            border-radius: 999px;
            background: #f3f4f6;
            padding: 3px;
        }

        .tab {
            flex: 1;
            text-align: center;
            padding: 8px 0;
            cursor: pointer;
            border-radius: 999px;
            font-size: 14px;
            font-weight: 500;
            color: #6b7280;
        }

        .tab.active {
            background: #2563eb;
            color: #ffffff;
        }

        form {
            display: none;
            margin-top: 4px;
        }

        form.active {
            display: block;
        }

        label {
            display: block;
            margin-top: 10px;
            margin-bottom: 4px;
            font-size: 13px;
            color: #374151;
        }

        input[type="text"],
        input[type="email"],
        input[type="password"],
        select {
            width: 100%;
            padding: 8px 10px;
            border-radius: 6px;
            border: 1px solid #d1d5db;
            font-size: 14px;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 1px rgba(37,99,235,0.15);
        }

        button {
            margin-top: 16px;
            width: 100%;
            padding: 9px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: #ffffff;
            background: #2563eb;
        }

        button:hover {
            background: #1d4ed8;
        }

        .message {
            margin-top: 14px;
            font-size: 13px;
            padding: 8px 10px;
            border-radius: 6px;
            display: none;
            white-space: pre-wrap;
        }

        .message.success {
            background: #ecfdf3;
            color: #166534;
            border: 1px solid #bbf7d0;
            display: block;
        }

        .message.error {
            background: #fef2f2;
            color: #b91c1c;
            border: 1px solid #fecaca;
            display: block;
        }

        .small-note {
            margin-top: 10px;
            font-size: 11px;
            color: #9ca3af;
            text-align: center;
        }

        .debug {
            margin-top: 10px;
            font-size: 11px;
            color: #6b7280;
            background: #f9fafb;
            padding: 6px;
            border-radius: 6px;
            border: 1px dashed #e5e7eb;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>Capstone2 Auth</h1>
    <div class="subtitle">Login / Register ‚Ä¢ CLIENT or VENDOR</div>

    <div class="tabs">
        <div class="tab active" id="loginTab" onclick="showTab('login')">Login</div>
        <div class="tab" id="registerTab" onclick="showTab('register')">Register</div>
    </div>

    <!-- Login Form -->
    <form id="loginForm" class="active" onsubmit="handleLogin(event)">
        <label for="loginEmail">Email</label>
        <input type="email" id="loginEmail" required>

        <label for="loginPassword">Password</label>
        <input type="password" id="loginPassword" required>

        <button type="submit">Login</button>
    </form>

    <!-- Register Form -->
    <form id="registerForm" onsubmit="handleRegister(event)">
        <label for="regName">Name</label>
        <input type="text" id="regName" required>

        <label for="regEmail">Email</label>
        <input type="email" id="regEmail" required>

        <label for="regPassword">Password</label>
        <input type="password" id="regPassword" required>

        <label for="regRole">Role</label>
        <select id="regRole" required>
            <option value="">Select role...</option>
            <option value="CLIENT">Client (Tender Owner)</option>
            <option value="VENDOR">Vendor (Company)</option>
        </select>

        <button type="submit">Create Account</button>
    </form>

    <div id="message" class="message"></div>

    <div class="small-note">
        After login, user info will be stored in <b>localStorage</b><br>
        (currentUserId, currentUserName, currentUserRole)
    </div>

    <div id="debugBox" class="debug">
        localStorage:
        (not set yet)
    </div>
</div>

<script>
    function showTab(tab) {
        const loginTab = document.getElementById("loginTab");
        const registerTab = document.getElementById("registerTab");
        const loginForm = document.getElementById("loginForm");
        const registerForm = document.getElementById("registerForm");
        const msg = document.getElementById("message");
        msg.style.display = "none";

        if (tab === "login") {
            loginTab.classList.add("active");
            registerTab.classList.remove("active");
            loginForm.classList.add("active");
            registerForm.classList.remove("active");
        } else {
            registerTab.classList.add("active");
            loginTab.classList.remove("active");
            registerForm.classList.add("active");
            loginForm.classList.remove("active");
        }
    }

    async function handleLogin(event) {
        event.preventDefault();

        const email = document.getElementById("loginEmail").value.trim();
        const password = document.getElementById("loginPassword").value.trim();
        const msg = document.getElementById("message");

        // reset
        msg.className = "message";
        msg.textContent = "";
        msg.style.display = "none";

        try {
            const res = await fetch("/api/v1/auth/login", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({email, password})
            });

            const data = await res.json();

            if (!res.ok) {
                msg.classList.add("error");
                msg.textContent = data.message || "Login failed";
                msg.style.display = "block";      // üëà ŸÖŸáŸÖ
                return;
            }

            // success
            localStorage.setItem("currentUserId", data.id);
            localStorage.setItem("currentUserName", data.name);
            localStorage.setItem("currentUserRole", data.role);

            msg.classList.add("success");
            msg.textContent = "Logged in successfully as " + data.name + " (" + data.role + ")";
            msg.style.display = "block";

            updateDebugBox();

// üëá ÿ•ÿ∂ÿßŸÅÿ© Ÿáÿ∞ÿß ÿßŸÑÿ≥ÿ∑ÿ±:
            setTimeout(function () {
                window.location.href = "/dashboard.html";
            }, 800);

            // ŸÑÿßÿ≠ŸÇŸãÿß: ŸÜŸÇÿØÿ± ŸÜÿπŸÖŸÑ redirect ŸÑŸÄ dashboard
            // window.location.href = "/dashboard.html";
        } catch (e) {
            msg.classList.add("error");
            msg.textContent = "Error calling login API: " + e;
            msg.style.display = "block";          // üëà ŸÖŸáŸÖ
        }
    }


    async function handleRegister(event) {
        event.preventDefault();

        const name = document.getElementById("regName").value.trim();
        const email = document.getElementById("regEmail").value.trim();
        const password = document.getElementById("regPassword").value.trim();
        const role = document.getElementById("regRole").value;
        const msg = document.getElementById("message");

        msg.className = "message";
        msg.textContent = "";
        msg.style.display = "none";

        if (!role) {
            msg.classList.add("error");
            msg.textContent = "Please select a role";
            msg.style.display = "block";      // üëà
            return;
        }

        try {
            const res = await fetch("/api/v1/auth/register", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({
                    name: name,
                    email: email,
                    password: password,
                    role: role
                })
            });

            const data = await res.json();

            if (!res.ok) {
                msg.classList.add("error");
                msg.textContent = data.message || "Registration failed";
                msg.style.display = "block";  // üëà
                return;
            }

            msg.classList.add("success");
            msg.textContent = data.message || "User registered successfully";
            msg.style.display = "block";      // üëà

            showTab("login");
        } catch (e) {
            msg.classList.add("error");
            msg.textContent = "Error calling register API: " + e;
            msg.style.display = "block";      // üëà
        }
    }

    function updateDebugBox() {
        const box = document.getElementById("debugBox");
        const id = localStorage.getItem("currentUserId");
        const name = localStorage.getItem("currentUserName");
        const role = localStorage.getItem("currentUserRole");

        if (!id && !name && !role) {
            box.textContent = "localStorage:\n(not set yet)";
            return;
        }

        box.textContent =
            "localStorage:\n" +
            "currentUserId: " + id + "\n" +
            "currentUserName: " + name + "\n" +
            "currentUserRole: " + role;
    }

    // ÿ£ŸàŸÑ ŸÖÿß ÿ™ŸÅÿ™ÿ≠ ÿßŸÑÿµŸÅÿ≠ÿ©
    updateDebugBox();
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Proposals - Capstone2</title>
    <style>
        * { box-sizing: border-box; }
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background: #f3f4f6;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }
        .container {
            background: #ffffff;
            width: 1100px;
            max-width: 96vw;
            margin: 32px auto;
            padding: 26px 30px 28px;
            border-radius: 18px;
            box-shadow: 0 12px 30px rgba(0,0,0,0.08);
        }
        .top-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .back-btn {
            font-size: 12px;
            padding: 6px 12px;
            border-radius: 999px;
            border: 1px solid #e5e7eb;
            background: #ffffff;
            cursor: pointer;
        }
        .back-btn:hover { background: #f3f4f6; }
        .user-info {
            font-size: 13px;
            color: #4b5563;
        }
        h1 {
            margin: 6px 0 4px;
            text-align: center;
            font-size: 24px;
            color: #111827;
        }
        .subtitle {
            text-align: center;
            margin-bottom: 18px;
            font-size: 13px;
            color: #6b7280;
        }

        .filters {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            gap: 10px;
            flex-wrap: wrap;
        }
        .pill {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 999px;
            font-size: 12px;
            border: 1px solid #e5e7eb;
            background: #f9fafb;
            color: #4b5563;
        }
        select {
            padding: 6px 10px;
            border-radius: 999px;
            border: 1px solid #d1d5db;
            font-size: 12px;
            background: #ffffff;
        }

        .message {
            font-size: 13px;
            padding: 9px 12px;
            border-radius: 8px;
            margin-bottom: 12px;
            display: none;
        }
        .message.success { background: #ecfdf3; border: 1px solid #bbf7d0; color: #166534; display: block; }
        .message.error { background: #fef2f2; border: 1px solid #fecaca; color: #b91c1c; display: block; }
        .message.info { background: #eff6ff; border: 1px solid #bfdbfe; color: #1d4ed8; display: block; }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        thead { background: #f9fafb; }
        th, td {
            padding: 10px 8px;
            border-bottom: 1px solid #e5e7eb;
            text-align: left;
            vertical-align: top;
        }
        th {
            font-weight: 600;
            color: #4b5563;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.4px;
        }
        tbody tr:hover { background: #f9fafb; }

        .badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 11px;
            font-weight: 600;
        }
        .badge-draft { background: #eff6ff; color: #1d4ed8; }
        .badge-submitted { background: #ede9fe; color: #5b21b6; }
        .badge-needs { background: #fffbeb; color: #92400e; }
        .badge-approved { background: #ecfdf3; color: #15803d; }
        .badge-rejected { background: #fef2f2; color: #b91c1c; }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 999px;
            display: inline-block;
        }
        .dot-draft { background: #2563eb; }
        .dot-submitted { background: #6d28d9; }
        .dot-needs { background: #f97316; }
        .dot-approved { background: #16a34a; }
        .dot-rejected { background: #dc2626; }

        .links a {
            display: block;
            color: #2563eb;
            text-decoration: none;
            margin-bottom: 3px;
            word-break: break-all;
        }
        .links a:hover { text-decoration: underline; }
        .muted { color: #9ca3af; }

        .action-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            border-radius: 999px;
            border: none;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            margin: 2px 0;
        }
        .action-btn.primary { background: #2563eb; color: #ffffff; }
        .action-btn.secondary { background: #111827; color: #ffffff; }
        .action-btn.outline { background: #ffffff; color: #111827; border: 1px solid #d1d5db; }
        .action-btn.approve { background: #15803d; color: #ffffff; }
        .action-btn.reject { background: #b91c1c; color: #ffffff; }
        .action-btn:hover { opacity: 0.9; }
        .action-btn:disabled { opacity: 0.6; cursor: default; }

        .empty-state {
            text-align: center;
            padding: 40px 10px 20px;
            font-size: 13px;
            color: #6b7280;
        }

        .notes {
            font-size: 12px;
            color: #4b5563;
            line-height: 1.4;
        }
        .notes strong { display: block; font-size: 11px; color: #111827; }

        .hidden { display: none; }

        .note {
            margin-top: 14px;
            font-size: 11px;
            color: #9ca3af;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="top-row">
        <button class="back-btn" onclick="goBack()">‚Üê Back</button>
        <div class="user-info" id="userInfo"></div>
    </div>

    <h1 id="pageTitle">Proposals</h1>
    <div class="subtitle" id="subtitle">AI generated proposals overview.</div>

    <div id="filtersVendor" class="filters hidden">
        <div class="pill">Role: <strong id="roleLabelVendor">VENDOR</strong></div>
        <div class="pill">
            Status filter:
            <select id="statusFilterVendor" onchange="renderVendorTable()">
                <option value="ALL">All</option>
                <option value="DRAFT">Draft</option>
                <option value="SUBMITTED">Submitted</option>
                <option value="NEEDS_CHANGES">Needs Changes</option>
                <option value="APPROVED">Approved</option>
                <option value="REJECTED">Rejected</option>
            </select>
        </div>
    </div>

    <div id="filtersClient" class="filters hidden">
        <div class="pill">Role: <strong id="roleLabelClient">CLIENT</strong></div>
        <div class="pill">
            Tender filter:
            <select id="tenderFilter" onchange="renderClientTable()">
                <option value="ALL">All tenders</option>
            </select>
        </div>
        <div class="pill">
            Status filter:
            <select id="statusFilterClient" onchange="renderClientTable()">
                <option value="ALL">All statuses</option>
                <option value="SUBMITTED">Submitted</option>
                <option value="NEEDS_CHANGES">Needs Changes</option>
                <option value="APPROVED">Approved</option>
                <option value="REJECTED">Rejected</option>
                <option value="DRAFT">Draft</option>
            </select>
        </div>
    </div>

    <div id="message" class="message"></div>

    <div id="tableWrapper"></div>

    <div class="note">
        ‚Ä¢ Vendor history uses <code>/api/v1/proposals/vendor/{vendorId}/view</code> so titles are included in one call.<br>
        ‚Ä¢ Client review uses <code>/api/v1/proposals/client/{clientId}/view</code> and keeps status + links visible to both sides.
    </div>
</div>

<script>
    const state = {
        role: null,
        vendorId: null,
        clientId: null,
        proposals: [],
        tenderTitles: {},
        vendorNames: {},
        loading: false
    };

    const STATUS_BADGES = {
        "DRAFT": { badge: "badge-draft", dot: "dot-draft" },
        "SUBMITTED": { badge: "badge-submitted", dot: "dot-submitted" },
        "NEEDS_CHANGES": { badge: "badge-needs", dot: "dot-needs" },
        "APPROVED": { badge: "badge-approved", dot: "dot-approved" },
        "REJECTED": { badge: "badge-rejected", dot: "dot-rejected" }
    };

    function goBack() {
        window.location.href = "/dashboard.html";
    }

    function showMessage(type, text) {
        const msg = document.getElementById("message");
        msg.className = "message " + type;
        msg.textContent = text;
        msg.style.display = "block";
    }

    function clearMessage() {
        const msg = document.getElementById("message");
        msg.className = "message";
        msg.textContent = "";
        msg.style.display = "none";
    }

    async function initPage() {
        const id = localStorage.getItem("currentUserId");
        const name = localStorage.getItem("currentUserName");
        const role = localStorage.getItem("currentUserRole");

        if (!id || !role) {
            window.location.href = "/auth.html";
            return;
        }

        document.getElementById("userInfo").textContent =
            "Logged in as: " + name + " (ID: " + id + ")";

        state.role = role;
        if (role === "VENDOR") {
            state.vendorId = parseInt(id, 10);
            document.getElementById("filtersVendor").classList.remove("hidden");
            document.getElementById("pageTitle").textContent = "My Proposals";
            document.getElementById("subtitle").textContent = "All AI-generated proposals created by you.";
            document.getElementById("roleLabelVendor").textContent = role;
            await loadVendorProposals();
        } else if (role === "CLIENT") {
            state.clientId = parseInt(id, 10);
            document.getElementById("filtersClient").classList.remove("hidden");
            document.getElementById("pageTitle").textContent = "Proposals on My Tenders";
            document.getElementById("subtitle").textContent = "Review, approve, or request changes from vendors.";
            document.getElementById("roleLabelClient").textContent = role;
            await loadClientProposals();
        } else {
            showMessage("error", "Unsupported role: " + role);
        }
    }

    async function loadVendorProposals() {
        clearMessage();
        const wrapper = document.getElementById("tableWrapper");
        wrapper.innerHTML = "<div class='empty-state'>Loading proposals...</div>";

        try {
            const res = await fetch(`/api/v1/proposals/vendor/${state.vendorId}/view`);
            if (!res.ok) {
                const data = await res.json();
                wrapper.innerHTML = "<div class='empty-state'>" + (data.message || "Failed to load proposals.") + "</div>";
                return;
            }

            state.proposals = await res.json();
            if (!Array.isArray(state.proposals) || state.proposals.length === 0) {
                wrapper.innerHTML = "<div class='empty-state'>You have not generated any proposals yet.</div>";
                return;
            }

            state.proposals.forEach(p => {
                if (p.tenderId && p.tenderTitle) {
                    state.tenderTitles[p.tenderId] = p.tenderTitle;
                }
            });
            renderVendorTable();

        } catch (e) {
            console.error(e);
            wrapper.innerHTML = "<div class='empty-state'>Error loading proposals.</div>";
        }
    }

    async function loadClientProposals() {
        clearMessage();
        const wrapper = document.getElementById("tableWrapper");
        wrapper.innerHTML = "<div class='empty-state'>Loading proposals...</div>";

        try {
            const res = await fetch(`/api/v1/proposals/client/${state.clientId}/view`);
            if (!res.ok) {
                const data = await res.json();
                wrapper.innerHTML = "<div class='empty-state'>" + (data.message || "Failed to load proposals.") + "</div>";
                return;
            }

            state.proposals = await res.json();
            if (!Array.isArray(state.proposals) || state.proposals.length === 0) {
                wrapper.innerHTML = "<div class='empty-state'>No proposals submitted to your tenders yet.</div>";
                return;
            }

            const tenderIds = [...new Set(state.proposals.map(p => p.tenderId))];
            const vendorIds = [...new Set(state.proposals.map(p => p.vendorId))];
            state.proposals.forEach(p => {
                if (p.tenderId && p.tenderTitle) {
                    state.tenderTitles[p.tenderId] = p.tenderTitle;
                }
                if (p.vendorId && p.vendorName) {
                    state.vendorNames[p.vendorId] = p.vendorName;
                }
            });
            await Promise.all([
                preloadTenders(tenderIds.filter(id => !state.tenderTitles[id])),
                preloadVendors(vendorIds.filter(id => !state.vendorNames[id]))
            ]);
            populateClientTenderFilter(tenderIds);
            renderClientTable();

        } catch (e) {
            console.error(e);
            wrapper.innerHTML = "<div class='empty-state'>Error loading proposals.</div>";
        }
    }

    async function preloadTenders(ids) {
        for (const id of ids) {
            if (!id || state.tenderTitles[id]) continue;
            try {
                const res = await fetch(`/api/v1/tenders/get/${id}`);
                if (!res.ok) continue;
                const tender = await res.json();
                state.tenderTitles[id] = tender.title || ("Tender #" + id);
            } catch (e) {
                console.error("Error loading tender", id, e);
            }
        }
    }

    async function preloadVendors(ids) {
        for (const id of ids) {
            if (!id || state.vendorNames[id]) continue;
            try {
                const res = await fetch(`/api/v1/users/get/${id}`);
                if (!res.ok) continue;
                const user = await res.json();
                state.vendorNames[id] = user.name || ("Vendor #" + id);
            } catch (e) {
                console.error("Error loading vendor", id, e);
            }
        }
    }

    function populateClientTenderFilter(tenderIds) {
        const select = document.getElementById("tenderFilter");
        select.innerHTML = "<option value='ALL'>All tenders</option>";
        tenderIds.forEach(id => {
            const option = document.createElement("option");
            option.value = id;
            option.textContent = `#${id} - ${state.tenderTitles[id] || ("Tender #" + id)}`;
            select.appendChild(option);
        });
    }

    function renderVendorTable() {
        const wrapper = document.getElementById("tableWrapper");
        if (!Array.isArray(state.proposals) || state.proposals.length === 0) {
            wrapper.innerHTML = "<div class='empty-state'>You have not generated any proposals yet.</div>";
            return;
        }

        const filter = document.getElementById("statusFilterVendor").value;
        const filtered = state.proposals.filter(p => {
            if (filter === "ALL") return true;
            return (p.status || "").toUpperCase() === filter;
        });

        if (filtered.length === 0) {
            wrapper.innerHTML = "<div class='empty-state'>No proposals match this filter.</div>";
            return;
        }

        let html = `
            <table>
              <thead>
                <tr>
                  <th>Proposal</th>
                  <th>Tender</th>
                  <th>Status</th>
                  <th>Submitted</th>
                  <th>Client Feedback</th>
                  <th>Links</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
        `;

        filtered.forEach(p => {
            const status = (p.status || "DRAFT").toUpperCase();
            const badge = STATUS_BADGES[status] || STATUS_BADGES.DRAFT;
            const tenderTitle = state.tenderTitles[p.tenderId] || ("Tender #" + p.tenderId);
            const submittedAt = p.submittedAt ? formatDateTime(p.submittedAt) : "‚Äî";
            const feedback = p.clientFeedback ? escapeHtml(p.clientFeedback) : "<span class='muted'>‚Äî</span>";
            const linksHtml = buildLinksHtml(p);
            const canSubmit = status === "DRAFT" || status === "NEEDS_CHANGES";
            const language = p.language ? `<div class='muted'>Language: ${escapeHtml(p.language)}</div>` : "";
            const notes = p.vendorNotes ? `<div class='muted'>Prompt notes: ${escapeHtml(p.vendorNotes)}</div>` : "";
            const submitMsg = p.submissionMessage ? `<div class='muted'>Last submit message: ${escapeHtml(p.submissionMessage)}</div>` : "";

            html += `
                <tr>
                  <td>
                    <div><strong>#${p.id}</strong></div>
                    ${language}
                    ${notes}
                    ${submitMsg}
                  </td>
                  <td>
                    <div><strong>${escapeHtml(tenderTitle)}</strong></div>
                    <div class='muted'>Tender ID: ${p.tenderId}</div>
                  </td>
                  <td>
                    <span class="badge ${badge.badge}">
                      <span class="status-dot ${badge.dot}"></span>${status}
                    </span>
                  </td>
                  <td>${submittedAt}</td>
                  <td>${feedback}</td>
                  <td class="links">${linksHtml}</td>
                  <td>
                    ${canSubmit ? `<button class="action-btn primary" onclick="submitFromList(${p.id})">üì§ Submit</button>` : ""}
                    <button class="action-btn outline" onclick="openGenerator(${p.tenderId})">üîÅ Regenerate</button>
                  </td>
                </tr>
            `;
        });

        html += "</tbody></table>";
        wrapper.innerHTML = html;
    }

    function renderClientTable() {
        const wrapper = document.getElementById("tableWrapper");
        if (!Array.isArray(state.proposals) || state.proposals.length === 0) {
            wrapper.innerHTML = "<div class='empty-state'>No proposals submitted to your tenders yet.</div>";
            return;
        }

        const tenderFilter = document.getElementById("tenderFilter").value;
        const statusFilter = document.getElementById("statusFilterClient").value;

        const filtered = state.proposals.filter(p => {
            const status = (p.status || "").toUpperCase();
            if (statusFilter !== "ALL" && status !== statusFilter) {
                return false;
            }
            if (tenderFilter !== "ALL" && p.tenderId !== parseInt(tenderFilter, 10)) {
                return false;
            }
            return true;
        });

        if (filtered.length === 0) {
            wrapper.innerHTML = "<div class='empty-state'>No proposals match this filter.</div>";
            return;
        }

        let html = `
            <table>
              <thead>
                <tr>
                  <th>Proposal</th>
                  <th>Tender</th>
                  <th>Vendor</th>
                  <th>Status</th>
                  <th>Submitted</th>
                  <th>Vendor Messages</th>
                  <th>Links</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
        `;

        filtered.forEach(p => {
            const status = (p.status || "DRAFT").toUpperCase();
            const badge = STATUS_BADGES[status] || STATUS_BADGES.DRAFT;
            const tenderTitle = state.tenderTitles[p.tenderId] || ("Tender #" + p.tenderId);
            const vendorName = state.vendorNames[p.vendorId] || ("Vendor #" + p.vendorId);
            const submittedAt = p.submittedAt ? formatDateTime(p.submittedAt) : "‚Äî";
            const linksHtml = buildLinksHtml(p);
            const vendorMessages = buildVendorMessages(p);
            const canDecide = status === "SUBMITTED";

            html += `
                <tr>
                  <td>
                    <div><strong>#${p.id}</strong></div>
                    <div class='muted'>Proposal status history visible below.</div>
                    ${p.clientFeedback ? `<div class='notes'><strong>Client feedback:</strong>${escapeHtml(p.clientFeedback)}</div>` : ""}
                  </td>
                  <td>
                    <div><strong>${escapeHtml(tenderTitle)}</strong></div>
                    <div class='muted'>Tender ID: ${p.tenderId}</div>
                  </td>
                  <td>
                    <div><strong>${escapeHtml(vendorName)}</strong></div>
                    <div class='muted'>Vendor ID: ${p.vendorId}</div>
                  </td>
                  <td>
                    <span class="badge ${badge.badge}">
                      <span class="status-dot ${badge.dot}"></span>${status}
                    </span>
                  </td>
                  <td>${submittedAt}</td>
                  <td>${vendorMessages}</td>
                  <td class="links">${linksHtml}</td>
                  <td>
                    ${canDecide ? `
                        <button class="action-btn approve" onclick="clientDecision(${p.id}, 'APPROVED')">‚úÖ Approve</button>
                        <button class="action-btn reject" onclick="clientDecision(${p.id}, 'REJECTED')">‚ùå Reject</button>
                        <button class="action-btn secondary" onclick="clientDecision(${p.id}, 'NEEDS_CHANGES')">‚úèÔ∏è Request Changes</button>
                    ` : "<span class='muted'>No actions available</span>"}
                  </td>
                </tr>
            `;
        });

        html += "</tbody></table>";
        wrapper.innerHTML = html;
    }

    function buildLinksHtml(proposal) {
        const parts = [];
        if (proposal.gammaShareLink) {
            parts.push(`<a href="${proposal.gammaShareLink}" target="_blank">Gamma Presentation</a>`);
        }
        if (proposal.pdfUrl) {
            parts.push(`<a href="${proposal.pdfUrl}" target="_blank">PDF Export</a>`);
        }
        if (proposal.pptxUrl) {
            parts.push(`<a href="${proposal.pptxUrl}" target="_blank">PPTX Export</a>`);
        }
        if (parts.length === 0) {
            return "<span class='muted'>No links yet</span>";
        }
        return parts.join("");
    }

    function buildVendorMessages(proposal) {
        const messages = [];
        if (proposal.language) {
            messages.push(`<div class='muted'>Language: ${escapeHtml(proposal.language)}</div>`);
        }
        if (proposal.vendorNotes) {
            messages.push(`<div class='notes'><strong>Prompt notes</strong>${escapeHtml(proposal.vendorNotes)}</div>`);
        }
        if (proposal.submissionMessage) {
            messages.push(`<div class='notes'><strong>Submit message</strong>${escapeHtml(proposal.submissionMessage)}</div>`);
        }
        if (messages.length === 0) {
            return "<span class='muted'>‚Äî</span>";
        }
        return messages.join("");
    }

    function formatDateTime(iso) {
        try {
            return new Date(iso).toLocaleString();
        } catch (e) {
            return iso;
        }
    }

    function escapeHtml(value) {
        if (!value) return "";
        return value.replace(/[&<>"']/g, function (c) {
            return {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#39;'
            }[c];
        });
    }

    function openGenerator(tenderId) {
        window.location.href = `/proposal-generate.html?tenderId=${tenderId}`;
    }

    async function submitFromList(proposalId) {
        const proposal = state.proposals.find(p => p.id === proposalId);
        if (!proposal) {
            showMessage("error", "Proposal not found in list.");
            return;
        }
        const defaultMessage = proposal.submissionMessage || "";
        const message = prompt("Message to client (optional):", defaultMessage);
        if (message === null) {
            return; // user cancelled
        }
        clearMessage();
        try {
            const res = await fetch(`/api/v1/proposals/${proposalId}/submit`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ vendorId: state.vendorId, message: message.trim() })
            });
            const data = await res.json();
            if (!res.ok) {
                showMessage("error", data.message || "Failed to submit proposal.");
                return;
            }
            showMessage("success", "Proposal submitted to client.");
            await loadVendorProposals();
        } catch (e) {
            console.error(e);
            showMessage("error", "Error submitting proposal: " + e);
        }
    }

    async function clientDecision(proposalId, decision) {
        const proposal = state.proposals.find(p => p.id === proposalId);
        if (!proposal) {
            showMessage("error", "Proposal not found.");
            return;
        }

        let note = "";
        if (decision === "NEEDS_CHANGES") {
            note = prompt("Enter feedback for the vendor (required):", proposal.clientFeedback || "");
            if (note === null) {
                return;
            }
            if (!note.trim()) {
                alert("Feedback is required when requesting changes.");
                return;
            }
        } else {
            note = prompt("Feedback for the vendor (optional):", proposal.clientFeedback || "");
            if (note === null) {
                return;
            }
        }

        clearMessage();
        try {
            const endpoint = decision === "APPROVED" ? "approve" : decision === "REJECTED" ? "reject" : "request-changes";
            const res = await fetch(`/api/v1/proposals/${proposalId}/${endpoint}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ clientId: state.clientId, note: note.trim() })
            });
            const data = await res.json();
            if (!res.ok) {
                showMessage("error", data.message || "Action failed.");
                return;
            }
            showMessage("success", "Proposal status updated.");
            await loadClientProposals();
        } catch (e) {
            console.error(e);
            showMessage("error", "Error while updating proposal: " + e);
        }
    }

    initPage();
</script>

</body>
</html>

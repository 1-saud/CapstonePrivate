<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Generate Proposal (AI) - Capstone2</title>
    <style>
        * { box-sizing: border-box; }
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background: #f3f4f6;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .container {
            background: #ffffff;
            width: 900px;
            max-width: 95vw;
            padding: 24px 28px 26px;
            border-radius: 18px;
            box-shadow: 0 12px 30px rgba(0,0,0,0.08);
        }
        .top-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .back-btn {
            font-size: 12px;
            padding: 6px 12px;
            border-radius: 999px;
            border: 1px solid #e5e7eb;
            background: #ffffff;
            cursor: pointer;
        }
        .back-btn:hover { background: #f3f4f6; }
        .user-info {
            font-size: 13px;
            color: #4b5563;
        }
        h1 {
            margin: 4px 0 4px;
            text-align: center;
            font-size: 24px;
            color: #111827;
        }
        .subtitle {
            text-align: center;
            margin-bottom: 18px;
            font-size: 13px;
            color: #6b7280;
        }

        label {
            display: block;
            margin-top: 10px;
            margin-bottom: 4px;
            font-size: 13px;
            color: #374151;
        }

        select,
        textarea {
            width: 100%;
            padding: 8px 10px;
            border-radius: 10px;
            border: 1px solid #d1d5db;
            font-size: 14px;
            background: #ffffff;
        }
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 1px rgba(37,99,235,0.16);
        }
        textarea {
            min-height: 90px;
            resize: vertical;
        }

        .row {
            display: flex;
            gap: 14px;
            margin-top: 4px;
            flex-wrap: wrap;
        }
        .row > div { flex: 1; min-width: 220px; }

        .helper {
            font-size: 12px;
            color: #9ca3af;
            margin-top: 2px;
        }

        button.primary {
            margin-top: 18px;
            width: 100%;
            padding: 12px;
            border-radius: 999px;
            border: none;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            background: #2563eb;
            color: #ffffff;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        button.primary:hover { background: #1d4ed8; }
        button.primary:disabled {
            opacity: 0.6;
            cursor: default;
        }

        .secondary-btn {
            padding: 10px 16px;
            border-radius: 999px;
            border: none;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            background: #2563eb;
            color: #ffffff;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .secondary-btn.outline {
            background: #ffffff;
            border: 1px solid #d1d5db;
            color: #111827;
        }
        .secondary-btn:hover {
            opacity: 0.9;
        }
        .secondary-btn:disabled {
            opacity: 0.6;
            cursor: default;
        }

        .message {
            margin-top: 14px;
            font-size: 13px;
            padding: 8px 10px;
            border-radius: 8px;
            display: none;
        }
        .message.success {
            background: #ecfdf3;
            color: #166534;
            border: 1px solid #bbf7d0;
            display: block;
        }
        .message.error {
            background: #fef2f2;
            color: #b91c1c;
            border: 1px solid #fecaca;
            display: block;
        }
        .message.info {
            background: #eef2ff;
            color: #3730a3;
            border: 1px solid #c7d2fe;
            display: block;
        }

        .links-box {
            margin-top: 10px;
            padding: 10px 12px;
            border-radius: 10px;
            background: #f9fafb;
            border: 1px dashed #e5e7eb;
            font-size: 12px;
            display: none;
        }
        .links-box a {
            color: #2563eb;
            text-decoration: none;
            word-break: break-all;
        }
        .links-box a:hover { text-decoration: underline; }
        .muted {
            color: #9ca3af;
        }

        .actions-box {
            margin-top: 16px;
            padding: 16px 18px;
            border-radius: 12px;
            background: #fefce8;
            border: 1px solid #facc15;
            font-size: 12px;
            display: none;
        }
        .actions-header {
            font-weight: 600;
            margin-bottom: 8px;
            color: #78350f;
            font-size: 13px;
        }
        .status-chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 600;
        }
        .chip-draft { background: #eff6ff; color: #1d4ed8; }
        .chip-submitted { background: #ede9fe; color: #5b21b6; }
        .chip-needs { background: #fffbeb; color: #92400e; }
        .chip-approved { background: #ecfdf3; color: #15803d; }
        .chip-rejected { background: #fef2f2; color: #b91c1c; }

        .feedback-box {
            margin-top: 12px;
            padding: 10px 12px;
            border-radius: 10px;
            border: 1px solid #fde68a;
            background: #fffbeb;
            color: #92400e;
            display: none;
        }
        .feedback-box h4 {
            margin: 0 0 6px;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.6px;
        }
        .feedback-box p {
            margin: 0;
            font-size: 12px;
            line-height: 1.5;
        }

        .submit-area {
            margin-top: 14px;
            padding-top: 12px;
            border-top: 1px solid #facc15;
            display: none;
        }
        .submit-area textarea {
            min-height: 70px;
            font-size: 12px;
        }
        .submit-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .info-line {
            margin-top: 8px;
            color: #6b7280;
            font-size: 11px;
        }

        .note {
            margin-top: 16px;
            font-size: 11px;
            color: #9ca3af;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="top-row">
        <button class="back-btn" onclick="goBack()">‚Üê Back</button>
        <div class="user-info" id="userInfo"></div>
    </div>

    <h1>Generate Proposal (AI)</h1>
    <div class="subtitle">
        Vendor selects a tender, language, and optional notes.<br>
        Backend calls Gamma to create a proposal and store links automatically.
    </div>

    <form id="generateForm" onsubmit="handleGenerate(event)">
        <div class="row">
            <div>
                <label for="tenderSelect">Select Tender</label>
                <select id="tenderSelect" required>
                    <option value="">Loading open tenders...</option>
                </select>
                <div class="helper">
                    * Loaded from <code>/api/v1/tenders/status/OPEN</code>
                </div>
            </div>

            <div>
                <label for="languageSelect">Language</label>
                <select id="languageSelect" required>
                    <option value="Arabic">Arabic</option>
                    <option value="English">English</option>
                </select>
                <div class="helper">
                    Used while building the AI prompt (ar / en for Gamma).
                </div>
            </div>
        </div>

        <label for="notes">Additional Notes (optional)</label>
        <textarea id="notes"
                  placeholder="Anything specific you want AI to focus on? Scope, technologies, contract duration, references, etc."></textarea>

        <button class="primary" type="submit" id="generateBtn">
            <span>ü§ñ</span>
            <span id="btnText">Generate Proposal</span>
        </button>
    </form>

    <div id="message" class="message"></div>

    <div id="linksBox" class="links-box">
        <div><strong>Gamma presentation:</strong> <a id="gammaLink" href="#" target="_blank"></a></div>
        <div id="pdfRow" style="margin-top:6px; display:none;">
            <strong>PDF export:</strong> <a id="pdfLink" href="#" target="_blank"></a>
        </div>
        <div id="pptxRow" style="margin-top:6px; display:none;">
            <strong>PPTX export:</strong> <a id="pptxLink" href="#" target="_blank"></a>
        </div>
        <div id="linksEmpty" class="muted" style="margin-top:6px; display:none;">
            Gamma is still preparing exports. Refresh this page later if links are missing.
        </div>
    </div>

    <div id="actionsBox" class="actions-box">
        <div class="actions-header">Proposal status & next steps</div>
        <div>
            <span class="status-chip chip-draft" id="statusChip">DRAFT</span>
        </div>
        <div class="info-line" id="submittedInfo"></div>
        <div class="info-line" id="languageInfo"></div>
        <div class="info-line" id="vendorNotesInfo"></div>

        <div id="feedbackBox" class="feedback-box">
            <h4>Client feedback</h4>
            <p id="feedbackText"></p>
        </div>

        <div id="submitArea" class="submit-area">
            <label for="submitMessage">Message to client (optional)</label>
            <textarea id="submitMessage" placeholder="Example: Added more details about maintenance contract. Please review."></textarea>
            <div class="submit-actions">
                <button type="button" class="secondary-btn" id="submitBtn" onclick="submitToClient()">
                    üì§ Submit to Client
                </button>
                <button type="button" class="secondary-btn outline" onclick="openMyProposals()">
                    üìÇ Go to My Proposals
                </button>
            </div>
        </div>

        <div id="submittedOnly" class="submit-area" style="border-top:none; padding-top:0; display:none;">
            <button type="button" class="secondary-btn outline" onclick="openMyProposals()">
                üìÇ Go to My Proposals
            </button>
        </div>
    </div>

    <div class="note">
        ‚Ä¢ On success, backend returns a <code>Proposal</code> entity (status, gammaShareLink, pdfUrl, pptxUrl...).<br>
        ‚Ä¢ This page reads <code>currentUserId</code>, <code>currentUserName</code>, <code>currentUserRole</code> from <code>localStorage</code>.
    </div>
</div>

<script>
    let currentVendorId = null;
    let lastProposal = null;

    const STATUS_CHIPS = {
        "DRAFT": { label: "Draft ‚Äì not sent to client yet", className: "chip-draft" },
        "SUBMITTED": { label: "Submitted ‚Äì waiting for client decision", className: "chip-submitted" },
        "NEEDS_CHANGES": { label: "Needs changes ‚Äì check client feedback and resubmit", className: "chip-needs" },
        "APPROVED": { label: "Approved ‚Äì proposal accepted", className: "chip-approved" },
        "REJECTED": { label: "Rejected ‚Äì proposal declined", className: "chip-rejected" }
    };

    async function initPage() {
        const id = localStorage.getItem("currentUserId");
        const name = localStorage.getItem("currentUserName");
        const role = localStorage.getItem("currentUserRole");

        if (!id || role !== "VENDOR") {
            window.location.href = "/auth.html";
            return;
        }

        currentVendorId = parseInt(id, 10);
        document.getElementById("userInfo").textContent =
            "Vendor: " + name + " (ID: " + id + ")";

        await loadOpenTenders();
    }

    function goBack() {
        window.location.href = "/dashboard.html";
    }

    function showMessage(type, text) {
        const msg = document.getElementById("message");
        msg.className = "message " + type;
        msg.textContent = text;
        msg.style.display = "block";
    }

    function clearMessage() {
        const msg = document.getElementById("message");
        msg.className = "message";
        msg.textContent = "";
        msg.style.display = "none";
    }

    function setLoading(isLoading) {
        const btn = document.getElementById("generateBtn");
        const text = document.getElementById("btnText");
        btn.disabled = isLoading;
        text.textContent = isLoading ? "Generating, please wait..." : "Generate Proposal";
    }

    function setSubmitLoading(isLoading) {
        const btn = document.getElementById("submitBtn");
        if (!btn) return;
        btn.disabled = isLoading;
        btn.textContent = isLoading ? "Submitting..." : "üì§ Submit to Client";
    }

    async function loadOpenTenders() {
        const select = document.getElementById("tenderSelect");
        select.innerHTML = "<option value=''>Loading...</option>";

        try {
            const res = await fetch("/api/v1/tenders/status/OPEN");
            if (!res.ok) {
                select.innerHTML = "<option value=''>Failed to load tenders</option>";
                return;
            }

            const tenders = await res.json();
            if (!Array.isArray(tenders) || tenders.length === 0) {
                select.innerHTML = "<option value=''>No open tenders available</option>";
                return;
            }

            const urlParams = new URLSearchParams(window.location.search);
            const preselectedId = urlParams.get("tenderId");

            select.innerHTML = "<option value=''>-- Select a tender --</option>";
            tenders.forEach(t => {
                const opt = document.createElement("option");
                opt.value = t.id;
                opt.textContent = "#" + t.id + " - " + t.title;
                if (preselectedId && parseInt(preselectedId, 10) === t.id) {
                    opt.selected = true;
                }
                select.appendChild(opt);
            });

        } catch (e) {
            console.error(e);
            select.innerHTML = "<option value=''>Error loading tenders</option>";
        }
    }

    async function handleGenerate(event) {
        event.preventDefault();
        clearMessage();
        toggleLinks(false);
        toggleActions(false);
        lastProposal = null;

        const tenderId = parseInt(document.getElementById("tenderSelect").value, 10);
        const language = document.getElementById("languageSelect").value;
        const notes = document.getElementById("notes").value.trim();

        if (!tenderId) {
            showMessage("error", "Please select a tender first.");
            return;
        }

        const payload = {
            vendorId: currentVendorId,
            tenderId: tenderId,
            language: language,
            notes: notes
        };

        setLoading(true);

        try {
            const res = await fetch("/api/v1/proposals/generate", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });

            const data = await res.json();

            if (!res.ok) {
                const msg = data.message || "Failed to generate proposal.";
                showMessage("error", msg);
                setLoading(false);
                return;
            }

            lastProposal = data;
            showMessage("success", "Proposal generated successfully. Review links below and submit to client when ready.");
            fillLinksBox(data);
            updateActionsBox(data);

        } catch (e) {
            console.error(e);
            showMessage("error", "Error while calling generate API: " + e);
        } finally {
            setLoading(false);
        }
    }

    function fillLinksBox(data) {
        const linksBox = document.getElementById("linksBox");
        const gammaLink = document.getElementById("gammaLink");
        const pdfRow = document.getElementById("pdfRow");
        const pdfLink = document.getElementById("pdfLink");
        const pptxRow = document.getElementById("pptxRow");
        const pptxLink = document.getElementById("pptxLink");
        const linksEmpty = document.getElementById("linksEmpty");

        let hasAnyLink = false;

        if (data.gammaShareLink) {
            gammaLink.href = data.gammaShareLink;
            gammaLink.textContent = data.gammaShareLink;
            hasAnyLink = true;
        } else {
            gammaLink.removeAttribute("href");
            gammaLink.textContent = "";
        }

        if (data.pdfUrl) {
            pdfRow.style.display = "block";
            pdfLink.href = data.pdfUrl;
            pdfLink.textContent = data.pdfUrl;
            hasAnyLink = true;
        } else {
            pdfRow.style.display = "none";
        }

        if (data.pptxUrl) {
            pptxRow.style.display = "block";
            pptxLink.href = data.pptxUrl;
            pptxLink.textContent = data.pptxUrl;
            hasAnyLink = true;
        } else {
            pptxRow.style.display = "none";
        }

        linksEmpty.style.display = hasAnyLink ? "none" : "block";
        toggleLinks(true);
    }

    function updateActionsBox(data) {
        if (!data || !data.id) {
            toggleActions(false);
            return;
        }

        const actionsBox = document.getElementById("actionsBox");
        const statusChip = document.getElementById("statusChip");
        const submitArea = document.getElementById("submitArea");
        const submittedOnly = document.getElementById("submittedOnly");
        const feedbackBox = document.getElementById("feedbackBox");
        const feedbackText = document.getElementById("feedbackText");
        const submitMessage = document.getElementById("submitMessage");
        const submittedInfo = document.getElementById("submittedInfo");
        const languageInfo = document.getElementById("languageInfo");
        const vendorNotesInfo = document.getElementById("vendorNotesInfo");

        actionsBox.style.display = "block";

        const status = (data.status || "DRAFT").toUpperCase();
        const chipConfig = STATUS_CHIPS[status] || STATUS_CHIPS.DRAFT;
        statusChip.textContent = chipConfig.label;
        statusChip.className = "status-chip " + chipConfig.className;

        languageInfo.textContent = data.language ? "Language selected: " + data.language : "";
        vendorNotesInfo.textContent = data.vendorNotes ? "Vendor notes used in prompt: " + data.vendorNotes : "";

        if (data.submittedAt) {
            submittedInfo.textContent = "Last submitted: " + formatDateTime(data.submittedAt);
        } else {
            submittedInfo.textContent = status === "SUBMITTED"
                ? "Submitted just now."
                : "Not submitted to client yet.";
        }

        feedbackBox.style.display = "none";
        feedbackText.textContent = "";

        if (status === "NEEDS_CHANGES" && data.clientFeedback) {
            feedbackBox.style.display = "block";
            feedbackText.textContent = data.clientFeedback;
        }
        if ((status === "APPROVED" || status === "REJECTED") && data.clientFeedback) {
            feedbackBox.style.display = "block";
            feedbackText.textContent = data.clientFeedback;
        }

        if (status === "DRAFT" || status === "NEEDS_CHANGES") {
            submitArea.style.display = "block";
            submittedOnly.style.display = "none";
            submitMessage.value = data.submissionMessage || "";
            setSubmitLoading(false);
        } else {
            submitArea.style.display = "none";
            submittedOnly.style.display = "block";
        }
    }

    function toggleLinks(visible) {
        const box = document.getElementById("linksBox");
        box.style.display = visible ? "block" : "none";
    }

    function toggleActions(visible) {
        const box = document.getElementById("actionsBox");
        box.style.display = visible ? "block" : "none";
    }

    function formatDateTime(isoString) {
        try {
            const date = new Date(isoString);
            return date.toLocaleString();
        } catch (_) {
            return isoString;
        }
    }

    async function submitToClient() {
        if (!lastProposal || !lastProposal.id) {
            showMessage("error", "Generate a proposal before submitting.");
            return;
        }

        clearMessage();
        const messageInput = document.getElementById("submitMessage");
        const payload = {
            vendorId: currentVendorId,
            message: messageInput.value.trim()
        };

        setSubmitLoading(true);

        try {
            const res = await fetch(`/api/v1/proposals/${lastProposal.id}/submit`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });

            const data = await res.json();
            if (!res.ok) {
                const msg = data.message || "Failed to submit proposal.";
                showMessage("error", msg);
                setSubmitLoading(false);
                return;
            }

            lastProposal = data;
            showMessage("success", "Proposal submitted to client successfully.");
            updateActionsBox(data);
        } catch (e) {
            console.error(e);
            showMessage("error", "Error while submitting proposal: " + e);
        } finally {
            setSubmitLoading(false);
        }
    }

    function openMyProposals() {
        window.location.href = "/proposal-list.html?mode=vendor";
    }

    initPage();
</script>

</body>
</html>
